<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <!-- 1. æ ¸å¿ƒé€‚é…ï¼šè®¾ç½®è§†å£ï¼Œç¡®ä¿ç§»åŠ¨ç«¯æ¸²æŸ“æ¯”ä¾‹æ­£ç¡® -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å•å¼ æµ·æŠ¥é…è‰²ç”Ÿæˆå™¨</title>
    <!-- å¼•å…¥ html-to-image åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html-to-image/1.11.11/html-to-image.min.js"></script>
    <style>
        :root {
            --c1: #BDEBC7;
            --c2: #C5F1F1;
            --c3: #C3CEEF;
            --c4: #D9D1EB;
            --poster-bg: #FDF8F0; 
            --title-color: #143068;
        }

        /* å…¨å±€ç›’æ¨¡å‹ï¼Œé˜²æ­¢paddingæ’‘ç ´å¸ƒå±€ */
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #2c2c2c;
            display: flex;
            justify-content: center;
            align-items: center; /* ç”µè„‘ç«¯å‚ç›´å±…ä¸­ */
            min-height: 100vh;
            margin: 0;
            color: #333;
            padding: 20px; /* è¾¹ç¼˜ç•™ç™½ */
        }

        .workspace {
            display: flex;
            gap: 40px;
            align-items: flex-start;
            flex-wrap: wrap;
            justify-content: center;
            width: 100%;
            max-width: 1200px;
        }

        /* --- å·¦ä¾§æ§åˆ¶é¢æ¿ --- */
        .controls {
            background: #fff;
            padding: 25px;
            border-radius: 16px;
            width: 300px; /* ç•¥å¾®åŠ å®½ */
            flex-shrink: 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .controls h3 { margin-top: 0; margin-bottom: 20px; color: #333; font-size: 18px; }
        
        .section-title {
            font-size: 12px; font-weight: bold; color: #888; 
            margin-top: 20px; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px;
        }

        .color-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            background: #f8f9fa;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid #eee;
            transition: border-color 0.2s;
        }
        .color-input-group:hover { border-color: #ccc; }
        .color-input-group label { width: 20px; font-weight: bold; color: #999; font-size: 14px; }
        
        .color-input-group input[type="color"] {
            border: none; width: 30px; height: 30px; cursor: pointer; background: none; margin-right: 10px; padding: 0;
        }
        
        .color-input-group input[type="text"] {
            border: none; background: transparent; width: 100%; 
            font-family: 'Monaco', monospace; font-size: 13px; color: #555;
            outline: none; text-transform: uppercase; cursor: copy;
        }
        
        select {
            width: 100%; padding: 10px; border: 1px solid #ddd; 
            border-radius: 8px; font-size: 14px; margin-bottom: 10px;
            background-color: #fff; outline: none;
        }
        
        /* é€šç”¨æŒ‰é’® */
        button {
            width: 100%; padding: 12px; border: none; 
            border-radius: 8px; font-weight: 600; cursor: pointer; margin-top: 8px;
            transition: 0.2s; font-size: 14px;
        }
        
        .btn-generate { background: #3b82f6; color: white; }
        .btn-generate:active { transform: scale(0.98); }
        .btn-generate:hover { background: #2563eb; }
        
        /* ä¿®æ”¹åçš„å¯¼å‡ºæŒ‰é’®æ ·å¼ */
        .btn-download { 
            background: #10b981; /* ç»¿è‰²ï¼Œè¡¨ç¤ºå®Œæˆ/ä¿å­˜ */
            color: white; 
            margin-top: 20px; 
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.2);
        }
        .btn-download:hover { background: #059669; }
        .btn-download:active { transform: scale(0.98); }
        .btn-download:disabled { background: #ccc; cursor: not-allowed; box-shadow: none; }

        /* æ–‡å­—é“¾æ¥æŒ‰é’® (ç”¨äºå¤åˆ¶æ•´ç»„) */
        .btn-text-action {
            display: block;
            text-align: right;
            font-size: 12px;
            color: #3b82f6;
            cursor: pointer;
            margin-top: 10px; /* å¢åŠ ä¸€ç‚¹é—´è· */
            text-decoration: none;
            font-weight: 500;
            padding: 5px 0; /* å¢åŠ ç‚¹å‡»åŒºåŸŸ */
        }
        .btn-text-action:hover { text-decoration: underline; color: #2563eb; }

        /* --- å³ä¾§æµ·æŠ¥åŒºåŸŸ (å“åº”å¼æ”¹é€ ) --- */
        .poster-card {
            width: 100%;
            max-width: 500px; /* ç”µè„‘ç«¯æœ€å¤§å®½åº¦ */
            /* ä½¿ç”¨ aspect-ratio ä¿æŒé•¿æ–¹å½¢æ¯”ä¾‹ï¼Œä¸å†å†™æ­» height */
            aspect-ratio: 5/6;
            min-height: 200px; /* ç”µè„‘ç«¯ä¿æŒé«˜åº¦ */
            
            background-color: var(--poster-bg);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 20px 60px rgba(0,0,0,0.4);
            position: relative;
            background-image: linear-gradient(rgba(255,255,255,0.5), rgba(255,255,255,0.5)); 
            padding: 40px 0;
            /* ç¡®ä¿å¯¼å‡ºæ—¶èƒŒæ™¯è‰²æ­£å¸¸ */
            overflow: hidden; 
        }

        /* æ ¸å¿ƒå¸ƒå±€å®¹å™¨ï¼šæ§åˆ¶å†…å®¹å æµ·æŠ¥å®½åº¦çš„ 80%ï¼Œå®ç°è‡ªé€‚åº” */
        .poster-content-wrapper {
            width: 80%;
            display: flex;
            flex-direction: column;
        }

        .poster-header {
            text-align: center;
            width: 100%;
            margin-bottom: 30px;
            display: flex;
            flex-direction: column;
        }

        .header-title {
            /* å­—ä½“æµä½“ç¼©æ”¾ï¼šæœ€å°32pxï¼Œæœ€å¤§48px */
            font-size: clamp(32px, 8vw, 48px);
            font-weight: 800; color: var(--title-color);
            text-transform: uppercase; letter-spacing: 2px;
            line-height: 1; margin-bottom: 0px;
            word-break: break-word;
        }

        .header-meta {
            display: flex;
            flex-direction: column;
            align-items: flex-end; 
            margin-top: 5px;
            width: 100%;
        }

        .serial-number {
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            font-weight: 600;
            color: #999;
            letter-spacing: 1px;
            margin-bottom: 5px;
            cursor: pointer;
            transition: color 0.2s;
        }
        .serial-number:hover { color: #3b82f6; }
        .serial-number:active { transform: scale(0.95); }

        .separator-line {
            width: 100%; height: 2px; background-color: #e0e0e0; border-radius: 2px;
        }

        /* è‰²å—åŒºåŸŸè‡ªé€‚åº” */
        .palette-container { 
            display: flex; 
            gap: 4%; /* ä½¿ç”¨ç™¾åˆ†æ¯”é—´è· */
            width: 100%;
            justify-content: space-between;
        }

        .swatch-group {
            display: flex; flex-direction: column; align-items: center; 
            flex: 1; /* å¹³åˆ†å®½åº¦ */
            cursor: pointer; transition: transform 0.2s;
        }
        /* å¯¼å‡ºæ—¶å»æ‰äº¤äº’æ•ˆæœï¼Œä½†è¿™ä¸å½±å“ html-to-image æˆªå›¾é™æ€å¸§ */
        .swatch-group:hover { transform: translateY(-5px); }
        .swatch-group:active { transform: translateY(0); }

        .color-rect {
            width: 100%; 
            /* ä¿æŒè‰²å—é•¿å®½æ¯” */
            aspect-ratio: 0.35; 
            min-height: 140px; 
            margin-bottom: 20px; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.08); 
            border-radius: 10px;
            transition: background-color 0.4s ease; 
        }
        
        .rect-1 { background-color: var(--c1); }
        .rect-2 { background-color: var(--c2); }
        .rect-3 { background-color: var(--c3); }
        .rect-4 { background-color: var(--c4); }

        .hex-label {
            font-size: clamp(10px, 3vw, 14px); /* å­—ä½“è‡ªé€‚åº” */
            font-weight: 600; color: #333;
            text-transform: uppercase; letter-spacing: 0.5px;
            font-family: 'Monaco', monospace;
            white-space: nowrap;
        }

        .watermark {
            margin-top: 40px; font-size: 14px; font-weight: 700;
            color: #4f4f4f; letter-spacing: 1px; font-family: sans-serif; opacity: 0.8;
        }

        /* --- ç§»åŠ¨ç«¯ä¸“ç”¨æ ·å¼ --- */
        @media screen and (max-width: 850px) {
            body {
                align-items: flex-start; /* é¡¶éƒ¨å¯¹é½ */
                padding: 15px;
                height: auto;
            }

            .workspace {
                flex-direction: column; /* ä¸Šä¸‹ç»“æ„ */
                align-items: center;
                gap: 20px;
            }

            .controls {
                width: 100%; /* é¢æ¿å æ»¡ */
                max-width: 500px;
            }

            .poster-card {
                width: 100%;
                min-height: auto; /* å–æ¶ˆå›ºå®šé«˜åº¦ */
                margin-bottom: 20px; 
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            }
        }

        /* --- Toast --- */
        #toast {
            visibility: hidden; min-width: 200px; margin-left: -100px;
            background-color: rgba(30, 30, 30, 0.9); color: #fff;
            text-align: center; border-radius: 50px; padding: 12px;
            position: fixed; z-index: 100; left: 50%; bottom: 30px;
            font-size: 14px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            opacity: 0; transform: translateY(20px); transition: all 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; transform: translateY(0); }


        /* --- æ–°å¢ï¼šç§»åŠ¨ç«¯å›¾ç‰‡é¢„è§ˆé®ç½©å±‚ --- */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
            padding: 20px;
        }

        .modal-content {
            max-width: 100%;
            max-height: 80%;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            /* æ ¸å¿ƒï¼šå…è®¸ç”¨æˆ·é•¿æŒ‰å›¾ç‰‡ */
            pointer-events: auto; 
            user-select: none;
        }

        .modal-tip {
            color: #fff; margin-top: 15px; font-size: 16px; font-weight: 500;
            text-align: center; letter-spacing: 1px;
        }

        .modal-close {
            margin-top: 20px;
            padding: 8px 24px;
            background: rgba(255,255,255,0.2);
            color: white; border: 1px solid white;
            border-radius: 20px; cursor: pointer; font-size: 14px;
        }
    </style>
</head>
<body>

<div class="workspace">
    
    <!-- å³ä¾§æµ·æŠ¥åŒºåŸŸ -->
    <div class="poster-card" id="myPoster">
        <!-- ä½¿ç”¨ Wrapper åŒ…è£¹å†…å®¹å®ç°è‡ªé€‚åº”å¯¹é½ -->
        <div class="poster-content-wrapper">
            <!-- å¤´éƒ¨ -->
            <div class="poster-header">
                <div class="header-title" id="themeTitle">PASTEL</div>
                <div class="header-meta">
                    <!-- ä¿æŒç‚¹å‡»å¤åˆ¶æ‰€æœ‰é¢œè‰²çš„åŠŸèƒ½ -->
                    <span class="serial-number" id="serialNo" onclick="copyAllHex()" title="ç‚¹å‡»å¤åˆ¶æ‰€æœ‰é¢œè‰²">No.001</span>
                    <div class="separator-line"></div>
                </div>
            </div>
            
            <!-- è‰²å— -->
            <div class="palette-container">
                <div class="swatch-group" onclick="copyColorByIndex(1)">
                    <div class="color-rect rect-1"></div>
                    <div class="hex-label" id="label-1">BDEBC7</div>
                </div>
                <div class="swatch-group" onclick="copyColorByIndex(2)">
                    <div class="color-rect rect-2"></div>
                    <div class="hex-label" id="label-2">C5F1F1</div>
                </div>
                <div class="swatch-group" onclick="copyColorByIndex(3)">
                    <div class="color-rect rect-3"></div>
                    <div class="hex-label" id="label-3">C3CEEF</div>
                </div>
                <div class="swatch-group" onclick="copyColorByIndex(4)">
                    <div class="color-rect rect-4"></div>
                    <div class="hex-label" id="label-4">D9D1EB</div>
                </div>
            </div>
        </div>

        <!-- <div class="watermark">@Kaimana</div> -->
    </div>

    <!-- å·¦ä¾§æ§åˆ¶é¢æ¿ -->
    <div class="controls">
        <h3>ğŸ¨ Kaimana's é…è‰²å·¥ä½œå°</h3>
        
        <div class="section-title">æ™ºèƒ½ç”Ÿæˆ</div>
        <select id="themeSelect">
            <option value="pastel">é©¬å¡é¾™ (Pastel)</option>
            <option value="vibrant">å¤šå·´èƒº (Vibrant)</option>
            <option value="morandi">è«å…°è¿ª (Morandi)</option>
            <option value="natural">è‡ªç„¶é£æ™¯ (Natural)</option>
            <option value="forest">æ£®æ—ç‰©è¯­ (Forest)</option>
            <option value="ocean">æ·±æµ·å¹½è“ (Ocean)</option>
            <option value="retro">å¤å¤èƒ¶ç‰‡ (Retro)</option>
            <option value="tradition">ä¸œæ–¹é›…éŸµ (Tradition)</option>
        </select>
        <button class="btn-generate" onclick="generateNewPalette()">âœ¨ éšæœºç”Ÿæˆé…è‰²</button>

        <div class="section-title" style="margin-top: 25px;">å¾®è°ƒé¢œè‰² (ç‚¹å‡»ç¼–ç å¤åˆ¶)</div>
        
        <div class="color-input-group">
            <label>1</label>
            <input type="color" id="p1" value="#BDEBC7" oninput="updatePoster(1, this.value)">
            <input type="text" id="t1" value="#BDEBC7" readonly onclick="copyFromInput(this)">
        </div>
        
        <div class="color-input-group">
            <label>2</label>
            <input type="color" id="p2" value="#C5F1F1" oninput="updatePoster(2, this.value)">
            <input type="text" id="t2" value="#C5F1F1" readonly onclick="copyFromInput(this)">
        </div>

        <div class="color-input-group">
            <label>3</label>
            <input type="color" id="p3" value="#C3CEEF" oninput="updatePoster(3, this.value)">
            <input type="text" id="t3" value="#C3CEEF" readonly onclick="copyFromInput(this)">
        </div>

        <div class="color-input-group">
            <label>4</label>
            <input type="color" id="p4" value="#D9D1EB" oninput="updatePoster(4, this.value)">
            <input type="text" id="t4" value="#D9D1EB" readonly onclick="copyFromInput(this)">
        </div>

        <!-- å°å·§çš„å¤åˆ¶æ•´ç»„æŒ‰é’® -->
        <a class="btn-text-action" onclick="copyAllHex()">ğŸ“‹ å¤åˆ¶æ•´ç»„è‰²å€¼</a>

        <!-- === ä¿®æ”¹ç‚¹ï¼šæŒ‰é’®æ”¹ä¸ºå¯¼å‡ºæµ·æŠ¥ === -->
        <button class="btn-download" id="btnExport" onclick="exportPoster()">ğŸ–¼ï¸ å¯¼å‡ºé«˜æ¸…æµ·æŠ¥</button>
    </div>
</div>

<div id="toast">å·²å¤åˆ¶åˆ°å‰ªè´´æ¿</div>

<!-- å›¾ç‰‡é¢„è§ˆå¼¹çª— (ç”¨äºç§»åŠ¨ç«¯é•¿æŒ‰ä¿å­˜) -->
<div id="imageModal" class="modal-overlay">
    <img id="generatedImage" class="modal-content" src="" alt="é•¿æŒ‰ä¿å­˜">
    <div class="modal-tip">ğŸ‘† é•¿æŒ‰ä¸Šæ–¹å›¾ç‰‡ä¿å­˜åˆ°ç›¸å†Œ</div>
    <button class="modal-close" onclick="closeModal()">å…³é—­</button>
</div>

<script>
    // æ•°å­¦å·¥å…·
    function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

    function hslToHex(h, s, l) {
        l /= 100;
        const a = s * Math.min(l, 1 - l) / 100;
        const f = n => {
            const k = (n + h / 30) % 12;
            const color = l - a * Math.max(Math.min(k - 3, 9 - k, 1), -1);
            return Math.round(255 * color).toString(16).padStart(2, '0');
        };
        return `#${f(0)}${f(8)}${f(4)}`.toUpperCase();
    }

    // ç®—æ³•é€»è¾‘
    function generateGradientColors(count, options) {
        const { 
            baseHue = rand(0, 360), hueSpan = rand(60,75), sRange = [60, 85], lRange = [30, 80],
            hueDirection = Math.random() > 0.5 ? 1 : -1
        } = options;
        let hslColors = [];
        for (let i = 0; i < count; i++) {
            const progress = i / (count - 1);
            const h = (baseHue + (progress * hueSpan * hueDirection) + 360) % 360;
            const s = rand(sRange[0], sRange[1]);
            const lStart = lRange[0], lEnd = lRange[1];
            let l = lStart + (progress * (lEnd - lStart)) + rand(-5, 5); 
            hslColors.push({h, s, l});
        }
        if (Math.random() > 0.5) hslColors.reverse();
        hslColors.sort(() => Math.random() - 0.5)
        return hslColors.map(c => hslToHex(c.h, c.s, c.l));
    }

    function getColorsByTheme(theme) {
        const count = 4;
        let hslColors = [];

        if (theme === 'vibrant') {
            const baseHue = rand(0, 360);
            const endHue = (baseHue + 120 + rand(0, 120)) % 360;
            hslColors.push({h: baseHue, s: rand(80, 100), l: rand(50, 65)});
            for (let i = 1; i < count - 1; i++) {
                const ratio = i / (count - 1);
                let h = (baseHue + (endHue - baseHue) * ratio + 360) % 360; 
                hslColors.push({h: h, s: rand(85, 95), l: rand(55, 70)});
            }
            hslColors.push({h: endHue, s: rand(80, 100), l: rand(50, 65)});
            hslColors.sort(() => Math.random() - 0.5)
            return hslColors.map(c => hslToHex(c.h, c.s, c.l));
        }
        else if (theme === 'morandi') {
            const baseHue = rand(0, 360);
            for(let i=0; i<count; i++) {
                let h = (baseHue + (i * 45) + rand(-15,15)) % 360; 
                hslColors.push({h, s: rand(10, 30), l: rand(60, 75)});
            }
            hslColors.sort((a, b) => a.l - b.l);
            hslColors.sort(() => Math.random() - 0.5)
            return hslColors.map(c => hslToHex(c.h, c.s, c.l));
        }
        else if (theme === 'pastel') {
            const baseHue = rand(0, 360);
            for(let i=0; i<count; i++) {
                hslColors.push({h: (baseHue + i * rand(30, 60)) % 360, s: rand(40, 70), l: rand(82, 92)});
            }
            hslColors.sort(() => Math.random() - 0.5)
            return hslColors.map(c => hslToHex(c.h, c.s, c.l));
        }
        else if (theme === 'natural') {
            return generateGradientColors(4, { hueSpan: rand(40, 80), sRange: [50, 80], lRange: [30, 85] });
        }
        else if (theme === 'forest') {
            if (Math.random() > 0.3) return generateGradientColors(4, { baseHue: rand(90, 140), hueSpan: 30, sRange: [30, 60], lRange: [25, 80] });
            else return [hslToHex(rand(100,140), rand(40,60), rand(20,35)), hslToHex(rand(90,130), rand(40,60), rand(60,80)), hslToHex(rand(25,45), rand(40,60), rand(30,50)), hslToHex(rand(30,50), rand(10,30), rand(85,95))];
        }
        else if (theme === 'ocean') {
            const mainHue = rand(190, 240); // è“åˆ°æ·±è“
            return [
                hslToHex(mainHue, rand(80, 100), rand(10, 35)),       
                hslToHex(mainHue + rand(-20, 20), rand(50, 70), rand(40, 60)), 
                hslToHex(rand(160, 190), rand(60, 90), rand(70, 85)), 
                Math.random() > 0.5 
                    ? hslToHex(rand(30, 50), rand(30, 60), rand(85, 95)) 
                    : hslToHex(mainHue, rand(10, 30), rand(90, 98))      
            ];
        }
        else if (theme === 'tradition') {
            const style = Math.random();
            if (style < 0.33) { 
                return [hslToHex(rand(350, 360), rand(70, 85), rand(35, 45)), hslToHex(rand(40, 50), rand(70, 90), rand(60, 75)), hslToHex(rand(0, 40), rand(5, 15), rand(90, 96)), hslToHex(rand(0, 0), rand(0, 5), rand(15, 25))];
            } else if (style < 0.66) {
                return [hslToHex(rand(210, 230), rand(60, 80), rand(25, 35)), hslToHex(rand(190, 210), rand(30, 50), rand(60, 75)), hslToHex(rand(200, 220), rand(10, 20), rand(85, 95)), hslToHex(rand(200, 220), rand(20, 40), rand(40, 50))];
            } else {
                return [hslToHex(rand(160, 180), rand(30, 50), rand(30, 45)), hslToHex(rand(35, 45), rand(40, 60), rand(60, 75)), hslToHex(rand(80, 100), rand(20, 40), rand(75, 85)), hslToHex(rand(30, 45), rand(20, 40), rand(88, 95))];
            }
        }
        else if (theme === 'retro') {
            const style = Math.random();
            let colors = [];
            if (style < 0.4) {
                colors = [hslToHex(rand(340, 360), rand(40, 60), rand(20, 35)), hslToHex(rand(160, 180), rand(30, 50), rand(15, 30)), hslToHex(rand(35, 50), rand(50, 70), rand(40, 55)), hslToHex(rand(200, 220), rand(20, 40), rand(30, 45))];
            } else if (style < 0.7) {
                const baseHue = rand(25, 45); 
                colors = [hslToHex(baseHue, rand(30, 50), rand(15, 25)), hslToHex(baseHue + rand(-5, 5), rand(25, 45), rand(35, 50)), hslToHex(baseHue + rand(-5, 5), rand(20, 40), rand(60, 75)), hslToHex(0, 0, rand(20, 35))];
            } else {
                colors = [hslToHex(rand(190, 210), rand(15, 30), rand(30, 45)), hslToHex(rand(0, 20), rand(15, 30), rand(40, 55)), hslToHex(rand(160, 180), rand(10, 25), rand(30, 50)), hslToHex(40, rand(10, 30), rand(75, 85))];
            }
            colors.sort(() => Math.random() - 0.5);
            return colors;
        }
        
        return ['#000000', '#333333', '#666666', '#999999'];
    }

    // UI äº¤äº’
    function generateNewPalette() {
        const themeSelect = document.getElementById('themeSelect');
        const themeValue = themeSelect.value;
        const colors = getColorsByTheme(themeValue);
        
        document.getElementById('themeTitle').innerText = themeValue;
        
        const randomNum = String(rand(1, 999)).padStart(3, '0');
        document.getElementById('serialNo').innerText = `No.${randomNum}`;

        colors.forEach((color, index) => {
            updatePoster(index + 1, color);
        });
    }

    function updatePoster(index, color) {
        if(!color.startsWith('#') && color.length === 6) color = '#' + color;
        
        document.documentElement.style.setProperty(`--c${index}`, color);

        let displayHex = color.replace('#', '').toUpperCase();
        document.getElementById(`label-${index}`).innerText = displayHex;
        document.getElementById(`p${index}`).value = color;
        document.getElementById(`t${index}`).value = color.toUpperCase();
    }

    // å·¥å…·ï¼šåˆ¤æ–­æ˜¯å¦ä¸ºç§»åŠ¨ç«¯
    function isMobile() {
        return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || window.innerWidth < 850;
    }

    // å·¥å…·ï¼šå…³é—­å¼¹çª—
    function closeModal() {
        document.getElementById('imageModal').style.display = 'none';
    }

    // === ä¿®æ”¹åçš„å¯¼å‡ºé€»è¾‘ ===
    function exportPoster() {
        const posterNode = document.getElementById('myPoster');
        const btn = document.getElementById('btnExport');
        const originalText = btn.innerHTML;

        btn.innerHTML = 'â³ æ¸²æŸ“ä¸­...';
        btn.disabled = true;

        // æ¸…é™¤é€‰ä¸­çŠ¶æ€ï¼Œé˜²æ­¢æˆªå›¾æ—¶åŒ…å«è“è‰²çš„é€‰ä¸­æ¡†
        if (window.getSelection) { window.getSelection().removeAllRanges(); }

        const theme = document.getElementById('themeTitle').innerText;
        const serial = document.getElementById('serialNo').innerText;
        const filename = `é…è‰²æµ·æŠ¥_${theme}_${serial}.png`;

        // ä½¿ç”¨ toBlob æ›¿ä»£ toPngï¼Œæ€§èƒ½æ›´å¥½ä¸”å…¼å®¹æ€§æ›´å¼º
        htmlToImage.toBlob(posterNode, {
            quality: 1.0,
            pixelRatio: 3, // é«˜æ¸…
            backgroundColor: '#FDF8F0'
        })
        .then(function (blob) {
            // åˆ›å»ºä¸€ä¸ªæŒ‡å‘å†…å­˜ä¸­ Blob çš„ URL (çŸ­é“¾æ¥ï¼Œä¸ä¼šå¯¼è‡´ URL è¿‡é•¿æŠ¥é”™)
            const url = URL.createObjectURL(blob);

            if (isMobile()) {
                // --- ç§»åŠ¨ç«¯é€»è¾‘ï¼šæ˜¾ç¤ºå¼¹çª— ---
                const modal = document.getElementById('imageModal');
                const img = document.getElementById('generatedImage');
                
                img.src = url; // è®¾ç½®å›¾ç‰‡æº
                modal.style.display = 'flex'; // æ˜¾ç¤ºå¼¹çª—
                
                showToast('è¯·é•¿æŒ‰å›¾ç‰‡ä¿å­˜ ğŸ“¸');
            } else {
                // --- ç”µè„‘ç«¯é€»è¾‘ï¼šè‡ªåŠ¨ä¸‹è½½ ---
                const link = document.createElement('a');
                link.download = filename;
                link.href = url;
                link.click();
                
                // é‡Šæ”¾å†…å­˜
                setTimeout(() => URL.revokeObjectURL(url), 1000);
                showToast('æµ·æŠ¥å·²å¯¼å‡º ğŸ‰');
            }

            // æ¢å¤æŒ‰é’®
            btn.innerHTML = originalText;
            btn.disabled = false;
        })
        .catch(function (error) {
            console.error('å¯¼å‡ºå¤±è´¥:', error);
            alert('å¯¼å‡ºå‡ºé”™ï¼Œè¯·é‡è¯•æˆ–æˆªå±ä¿å­˜ã€‚');
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }
    // å¤åˆ¶ä¸æç¤º
    function showToast(message) {
        var toast = document.getElementById("toast");
        toast.className = "show";
        toast.innerText = message;
        if(window.toastTimer) clearTimeout(window.toastTimer);
        window.toastTimer = setTimeout(function(){ toast.className = toast.className.replace("show", ""); }, 2000);
    }

    function copyFromInput(inputElement) {
        const color = inputElement.value;
        navigator.clipboard.writeText(color).then(() => {
            showToast(`é¢œè‰² ${color} å·²å¤åˆ¶`);
        });
    }

    function copyColorByIndex(index) {
        const color = document.getElementById(`t${index}`).value;
        navigator.clipboard.writeText(color).then(() => {
            showToast(`é¢œè‰² ${color} å·²å¤åˆ¶`);
        });
    }

    function copyAllHex() {
        const c1 = document.getElementById('t1').value;
        const c2 = document.getElementById('t2').value;
        const c3 = document.getElementById('t3').value;
        const c4 = document.getElementById('t4').value;
        const allColors = `${c1}, ${c2}, ${c3}, ${c4}`;
        
        navigator.clipboard.writeText(allColors).then(() => {
            showToast('æ•´ç»„é¢œè‰²å·²å¤åˆ¶');
        }).catch(err => {
            const textArea = document.createElement("textarea");
            textArea.value = allColors;
            document.body.appendChild(textArea);
            textArea.select();
            document.execCommand("Copy");
            textArea.remove();
            showToast('æ•´ç»„é¢œè‰²å·²å¤åˆ¶');
        });
    }

</script>

</body>
</html>
